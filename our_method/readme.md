# DEAP å¤šæ¨¡æ€æƒ…ç»ªè¯†åˆ«é¡¹ç›®ä»£ç åˆ†æ

## ä¸€ã€ä»£ç æ–‡ä»¶åˆ†ç±»ä¸åŠŸèƒ½è¯´æ˜

### ğŸ“Š æ•°æ®é¢„å¤„ç†æ¨¡å— (Data Preprocessing)

#### 1. `extract_video_frames_all.py`
**ä½œç”¨**ï¼šä»åŸå§‹è§†é¢‘ä¸­æå–å›¾åƒå¸§
- è¾“å…¥ï¼šDEAPæ•°æ®é›†çš„é¢éƒ¨è§†é¢‘ `.avi` æ–‡ä»¶ï¼ˆs01~s22ï¼Œæ¯äºº40ä¸ªtrialï¼‰
- è¾“å‡ºï¼šæå–çš„å›¾åƒå¸§ `.jpg` æ–‡ä»¶
- åŠŸèƒ½ï¼š
  - æ‰¹é‡å¤„ç†æ‰€æœ‰è¢«è¯•çš„è§†é¢‘
  - è°ƒæ•´å›¾åƒå°ºå¯¸ä¸º 224Ã—224
  - å¯è®¾ç½®å¸§ç‡é™åˆ¶ï¼ˆé»˜è®¤25fpsï¼‰

#### 2. `resnet_png_to_npy.py`
**ä½œç”¨**ï¼šä½¿ç”¨ResNet50æå–è§†è§‰ç‰¹å¾
- è¾“å…¥ï¼šæå–çš„å›¾åƒå¸§
- è¾“å‡ºï¼šæ¯ä¸ªtrialçš„ç‰¹å¾æ–‡ä»¶ `.npy`ï¼ˆå½¢çŠ¶ï¼š[T, 2048]ï¼‰
- åŠŸèƒ½ï¼š
  - ä½¿ç”¨é¢„è®­ç»ƒçš„ResNet50ï¼ˆå»æ‰åˆ†ç±»å¤´ï¼‰
  - å¯¹æ¯ä¸€å¸§æå–2048ç»´ç‰¹å¾å‘é‡
  - æŒ‰æ—¶é—´å †å æˆåºåˆ—ç‰¹å¾

#### 3. `repair_missing.py`
**ä½œç”¨**ï¼šä¿®è¡¥ç¼ºå¤±çš„é¢éƒ¨æ•°æ®
- é’ˆå¯¹ç‰¹å®šè¢«è¯•çš„ç¼ºå¤±trialï¼ˆs07, s09, s11ï¼‰
- æ™ºèƒ½è·³è¿‡å·²å­˜åœ¨çš„å¸§å’Œç‰¹å¾
- å®Œæˆ"æŠ½å¸§ â†’ æç‰¹å¾"çš„å®Œæ•´æµç¨‹

#### 4. `make_pkl.py`
**ä½œç”¨**ï¼šåˆ›å»º10æŠ˜äº¤å‰éªŒè¯æ•°æ®åŒ…ï¼ˆTrialçº§åˆ«åˆ’åˆ†ï¼‰
- è¾“å…¥ï¼šEEG `.mat` æ–‡ä»¶ + Facial `.npy` æ–‡ä»¶
- è¾“å‡ºï¼š`fold0.pkl` ~ `fold9.pkl`
- æ•°æ®å¤„ç†ï¼š
  - EEG: å–å‰32é€šé“ï¼Œå‰128æ—¶é—´æ­¥ï¼Œé€é€šé“z-scoreæ ‡å‡†åŒ–
  - Facial: pad/truncateåˆ°128å¸§
  - ä½¿ç”¨KFoldéšæœºåˆ’åˆ†ï¼ˆä¸è€ƒè™‘è¢«è¯•ç‹¬ç«‹æ€§ï¼‰

#### 5. `make_pkl_ind.py` â­
**ä½œç”¨**ï¼šåˆ›å»ºLOSOï¼ˆLeave-One-Subject-Outï¼‰æ•°æ®åŒ…ï¼ˆè¢«è¯•ç‹¬ç«‹ï¼‰
- è¾“å…¥ï¼šåŒä¸Š
- è¾“å‡ºï¼š`fold0_loso.pkl` ~ `fold21_loso.pkl`ï¼ˆ22ä¸ªè¢«è¯•ï¼‰
- æ¯ä¸ªfoldåŒ…å«ï¼š`{'train', 'val', 'test'}`
  - test = 1ä¸ªè¢«è¯•çš„æ‰€æœ‰trial
  - train/val = å…¶ä½™è¢«è¯•çš„trialæŒ‰9:1åˆ’åˆ†
- **è·¨è¢«è¯•æ ‡å‡†åŒ–**ï¼šæ‰€æœ‰splitä½¿ç”¨trainé›†çš„facialå‡å€¼/æ ‡å‡†å·®

#### 6. `openface_preprocess.py`
**ä½œç”¨**ï¼šæ—§ç‰ˆé¢„å¤„ç†ï¼ˆä½¿ç”¨OpenFaceç‰¹å¾ï¼‰
- ç°å·²å¼ƒç”¨ï¼Œé¡¹ç›®æ”¹ç”¨ResNet50ç‰¹å¾

---

### ğŸ§  æ¨¡å‹æ¶æ„æ¨¡å— (Model Architecture)

#### 1. `encoder.py`
**ä½œç”¨**ï¼šå®šä¹‰ä¸¤ä¸ªæ¨¡æ€çš„ç¼–ç å™¨
- **EEGEncoder**: 
  - è¾“å…¥ï¼š[B, 32, 128]
  - CNNæå– â†’ å±•å¹³ â†’ LinearæŠ•å½± â†’ ä½ç½®ç¼–ç 
  - è¾“å‡ºï¼š[B, 32, 128] (embed_dim=128)
  
- **FacialEncoder**:
  - è¾“å…¥ï¼š[B, T, 2048]
  - 1Då·ç§¯ â†’ BatchNorm â†’ æ—¶é—´å¯¹é½
  - è¾“å‡ºï¼š[B, T, 128]ï¼ˆè‡ªåŠ¨å¯¹é½åˆ°EEGæ—¶é—´æ­¥ï¼‰

#### 2. `fusion.py` â­
**ä½œç”¨**ï¼šå¤šæ¨¡æ€èåˆæ¨¡å‹ä¸»æ–‡ä»¶
- **CrossModalFusion**: åŒå‘äº¤å‰æ³¨æ„åŠ›ï¼ˆEEG â†” Facialï¼‰
- **AttentionPooling**: CLS tokenæ± åŒ–
- **BinaryClassificationHead**: äºŒåˆ†ç±»å¤´ï¼ˆ2ä¸ªç±»åˆ«ï¼‰
- **MultimodalFusionModel_Binary**: å®Œæ•´æ¨¡å‹æ¶æ„
  ```
  EEG â†’ EEGEncoder â†’ CrossFusion â† FacialEncoder â† Facial
                        â†“
                  AttentionPooling
                        â†“
                  Classification Head
  ```

#### 3. `attention.py`
**ä½œç”¨**ï¼šæ³¨æ„åŠ›æœºåˆ¶ï¼ˆä¼¼ä¸ºå†—ä½™æ–‡ä»¶ï¼‰
- å®šä¹‰äº†BiCrossAttentionï¼ˆä¸fusion.pyä¸­çš„CrossModalFusionç±»ä¼¼ï¼‰
- åŒ…å«NoCrossAttentionï¼ˆèº«ä»½æ˜ å°„ï¼Œç”¨äºæ¶ˆèå®éªŒï¼‰

#### 4. `loss.py`
**ä½œç”¨**ï¼šæŸå¤±å‡½æ•°ï¼ˆæœªè¢«å½“å‰ä»£ç ä½¿ç”¨ï¼‰
- FocalLoss
- JointMultitaskLossï¼ˆåˆ†ç±»+å›å½’ï¼‰
- WeightedFocalLoss

#### 5. `fusion_modules.py`
**çŠ¶æ€**ï¼šç©ºæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯åºŸå¼ƒçš„ï¼‰

---

### ğŸ“¦ æ•°æ®åŠ è½½æ¨¡å— (Data Loading)

#### `Multimodal_dataset.py` â­
**ä½œç”¨**ï¼šæ•°æ®é›†ç±»å’ŒåŠ è½½å™¨æ„å»º
- **MultimodalDataset**: åŸºç¡€æ•°æ®é›†ç±»
  - äºŒåˆ†ç±»æ ‡ç­¾ï¼švalence > 5.0 â†’ ç±»åˆ«1ï¼Œå¦åˆ™ç±»åˆ«0
  
- **BinaryDataset**: å¢å¼ºç‰ˆæ•°æ®é›†
  - æ”¯æŒå¯è°ƒé˜ˆå€¼
  - è·¨è¢«è¯•Facialæ ‡å‡†åŒ–
  
- **build_loaders_binary()**: Trialçº§åˆ«åˆ’åˆ†
  - ç”¨äº `main.py`
  
- **build_loaders_loso_binary()** â­: LOSOåˆ’åˆ†
  - ç”¨äº `main_loso.py`
  - åŒ…å«facialè·¨è¢«è¯•æ ‡å‡†åŒ–

---

### ğŸ¯ è®­ç»ƒè„šæœ¬ (Training Scripts)

#### 1. `main.py`
**ä½œç”¨**ï¼šç‹¬ç«‹è®­ç»ƒï¼ˆTrialçº§åˆ«10æŠ˜äº¤å‰éªŒè¯ï¼‰
- æ•°æ®ï¼š`make_pkl.py` ç”Ÿæˆçš„ `fold{0-9}.pkl`
- åˆ’åˆ†ï¼š**ä¸ä¿è¯è¢«è¯•ç‹¬ç«‹**ï¼ˆåŒä¸€è¢«è¯•çš„trialå¯èƒ½åˆ†æ•£åœ¨train/val/testï¼‰
- è¯„ä¼°ï¼šVal-ACCé€‰æœ€ä¼˜æ¨¡å‹
- ç±»åˆ«æƒé‡ï¼šæ ¹æ®è®­ç»ƒé›†åˆ†å¸ƒè‡ªåŠ¨è®¡ç®—
- è¾“å‡ºï¼š`output/binary_ind1/fold_results_binary.csv`

#### 2. `main_loso.py` â­â­â­
**ä½œç”¨**ï¼šLOSOè®­ç»ƒï¼ˆè¢«è¯•ç‹¬ç«‹ï¼Œ22æŠ˜ï¼‰
- æ•°æ®ï¼š`make_pkl_ind.py` ç”Ÿæˆçš„ `fold{0-21}_loso.pkl`
- åˆ’åˆ†ï¼š**ä¸¥æ ¼è¢«è¯•ç‹¬ç«‹**
  - Test = 1ä¸ªè¢«è¯•
  - Train/Val = å…¶ä½™è¢«è¯•
- **é«˜çº§ç‰¹æ€§**ï¼š
  - GroupNormæ›¿ä»£BatchNormï¼ˆå°æ‰¹é‡ç¨³å®šæ€§ï¼‰
  - Warmup + Cosineå­¦ä¹ ç‡è°ƒåº¦
  - æ¢¯åº¦è£å‰ª
  - **æ ¡å‡†å™¨é€‰æ‹©**ï¼šåœ¨valä¸Šæ¯”è¾ƒ `none/platt/temp` ä¸‰ç§æ ¡å‡†æ–¹æ³•
  - **é˜ˆå€¼ä¼˜åŒ–**ï¼šæ ¹æ®Val-BAé€‰Ï„*ï¼Œæ ¹æ®å…ˆéªŒé€‰Ï„_Ï€ï¼Œå–æœ€ä¼˜
  - **å¯é€‰å…ˆéªŒæ ¡æ­£**ï¼šEMç®—æ³•å¤„ç†label shift
- è¯„ä¼°æŒ‡æ ‡ï¼šACC, AUC, Balanced ACC
- è¾“å‡ºï¼š`output/binary_ind1/fold_results_binary.csv`

#### 3. `main_dep.py`
**ä½œç”¨**ï¼šä¾èµ–å¼/é“¾å¼è®­ç»ƒï¼ˆDependent Trainingï¼‰
- æ•°æ®ï¼š`make_data/fold{0-9}.pkl`
- **é“¾å¼åˆå§‹åŒ–**ï¼šæ¯ä¸ªfoldä»ä¸Šä¸€ä¸ªfoldçš„æœ€ä¼˜æ¨¡å‹warm-start
- å¯é€‰ç‰¹æ€§ï¼š
  - å‰Kä¸ªepochå†»ç»“encoderï¼Œåªè®­ç»ƒåˆ†ç±»å¤´
  - æ”¯æŒé¢„è®­ç»ƒæƒé‡åˆå§‹åŒ–
- é€‚ç”¨åœºæ™¯ï¼šæ•°æ®é‡å°æ—¶çš„å¢é‡å­¦ä¹ 

---

### ğŸ“ˆ è¯„ä¼°æ¨¡å— (Evaluation)

#### 1. `evaluate.py` â­â­
**ä½œç”¨**ï¼šå®Œæ•´çš„è¯„ä¼°å·¥å…·é›†ï¼ˆè¢«`main_loso.py`ä½¿ç”¨ï¼‰
- **Calibratorç±»**ï¼šä¸‰ç§åå¤„ç†æ ¡å‡†æ–¹æ³•
  - `none`: æ— æ ¡å‡†
  - `temp`: Temperature Scaling
  - `platt`: Platt Scalingï¼ˆé€»è¾‘å›å½’ï¼‰
  - `isotonic`: Isotonic Regressionï¼ˆå¯é€‰ï¼‰
  
- **é˜ˆå€¼æœç´¢**ï¼š
  - `find_best_tau_acc()`: æœ€å¤§åŒ–ACC
  - `find_best_tau_balanced()`: æœ€å¤§åŒ–Balanced-ACC
  
- **LOSOè¯„ä¼°** `evaluate_loso_binary()`:
  1. åœ¨Valä¸Šé€‰æ ¡å‡†å™¨ï¼ˆNLL/ECEï¼‰
  2. åœ¨Valä¸Šé€‰Ï„*ï¼ˆBA/ACCï¼‰
  3. è®¡ç®—Ï„_Ï€ï¼ˆå…ˆéªŒåŒ¹é…ï¼‰
  4. å¯é€‰EMå…ˆéªŒæ ¡æ­£
  5. è¿”å›å¤šç§ç»„åˆçš„æœ€ä¼˜ç»“æœ

- **è¾…åŠ©å‡½æ•°**ï¼š
  - `auc_with_T()`: å¸¦æ¸©åº¦çš„AUC
  - `maybe_flip_to_class1()`: AUC<0.5æ—¶ç¿»è½¬æ¦‚ç‡
  - `prior_correction_em()`: EMæ ‡ç­¾æ¼‚ç§»æ ¡æ­£

#### 2. `evaluate_new.py`
**ä½œç”¨**ï¼šç®€åŒ–ç‰ˆè¯„ä¼°ï¼ˆä»…ACCï¼‰
- ä»…åŒ…å«åŸºäºVal-ACCçš„é˜ˆå€¼é€‰æ‹©
- æœªè¢«å½“å‰ä¸»è„šæœ¬ä½¿ç”¨

---

### ğŸ”§ å·¥å…·è„šæœ¬ (Utilities)

#### `trail.py`
**ä½œç”¨**ï¼šæ£€æŸ¥pklæ–‡ä»¶å®Œæ•´æ€§
- éå†æŒ‡å®šç›®å½•çš„æ‰€æœ‰ `.pkl` æ–‡ä»¶
- æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œå¯è¯»æ€§
- åˆ—å‡ºæŸåçš„æ–‡ä»¶

---

## äºŒã€è¾“å…¥æ•°æ®è¯´æ˜

### åŸå§‹æ•°æ®
1. **EEGæ•°æ®**ï¼š`data_preprocessed_matlab/s{01-22}.mat`
   - å½¢çŠ¶ï¼š[40 trials, 40 channels, 8064 time_points]
   - ä½¿ç”¨ï¼šå‰32é€šé“ï¼Œå‰128æ—¶é—´æ­¥
   
2. **è§†é¢‘æ•°æ®**ï¼š`face_video/s{01-22}/s{XX}_trial{01-40}.avi`
   - 60ç§’è§†é¢‘ï¼Œè®°å½•è¢«è¯•è§‚çœ‹åˆºæ¿€æ—¶çš„é¢éƒ¨è¡¨æƒ…

3. **æ ‡ç­¾**ï¼šåŒ…å«åœ¨ `.mat` æ–‡ä»¶ä¸­
   - Valenceï¼ˆæ•ˆä»·ï¼‰
   - Arousalï¼ˆå”¤é†’åº¦ï¼‰
   - Likingï¼ˆå–œå¥½åº¦ï¼‰
   - **å½“å‰ä»»åŠ¡**ï¼šä»…ä½¿ç”¨Valenceè¿›è¡ŒäºŒåˆ†ç±»ï¼ˆ>5.0ä¸ºæ­£ç±»ï¼‰

### é¢„å¤„ç†åæ•°æ®
1. **Facialç‰¹å¾**ï¼š`Facial_CNN_Features/s{XX}/s{XX}_trial{YY}.npy`
   - å½¢çŠ¶ï¼š[T, 2048]ï¼ˆTä¸ºå¸§æ•°ï¼Œé€šå¸¸å‡ ç™¾å¸§ï¼‰
   
2. **æ•°æ®åŒ…**ï¼š
   - Trialçº§åˆ«ï¼š`make_data/fold{0-9}.pkl`
   - LOSOçº§åˆ«ï¼š`make_data_ind/fold{0-21}_loso.pkl`

---


## å››ã€ä»£ç æ‰§è¡Œæµç¨‹ï¼ˆæ¨èè·¯å¾„ï¼‰

### ğŸ”¹ è·¯å¾„1ï¼šLOSOè®­ç»ƒï¼ˆæ¨èï¼Œè¢«è¯•ç‹¬ç«‹ï¼‰â­

```
åŸå§‹æ•°æ®
    â†“
[1] extract_video_frames_all.py
    â†“ (è¾“å‡ºï¼šFacial_Frames/)
[2] resnet_png_to_npy.py
    â†“ (è¾“å‡ºï¼šFacial_CNN_Features/)
[3] repair_missing.py (å¯é€‰ï¼Œä»…ä¿®è¡¥ç¼ºå¤±)
    â†“
[4] make_pkl_ind.py
    â†“ (è¾“å‡ºï¼šfold0_loso.pkl ~ fold21_loso.pkl)
[5] main_loso.py
    â”œâ”€â”€ è°ƒç”¨ï¼šMultimodal_dataset.py (build_loaders_loso_binary)
    â”œâ”€â”€ è°ƒç”¨ï¼šfusion.py (MultimodalFusionModel_Binary)
    â”œâ”€â”€ è°ƒç”¨ï¼šencoder.py (EEGEncoder, FacialEncoder)
    â””â”€â”€ è°ƒç”¨ï¼ševaluate.py (evaluate_loso_binary, Calibrator)
    â†“
è¾“å‡ºï¼šoutput/binary_ind1/
    â”œâ”€â”€ best_fold{0-21}.pt (æ¨¡å‹æƒé‡)
    â””â”€â”€ fold_results_binary.csv (ç»“æœæ±‡æ€»)
```

### ğŸ”¹ è·¯å¾„2ï¼šTrialçº§åˆ«è®­ç»ƒï¼ˆä¸ä¿è¯è¢«è¯•ç‹¬ç«‹,è¢«è¯•ä¾èµ–ï¼‰

```
[1-3] åŒä¸Š
    â†“
[4] make_pkl.py
    â†“ (è¾“å‡ºï¼šfold0.pkl ~ fold9.pkl)
[5a] main.py (ç‹¬ç«‹è®­ç»ƒ)
     æˆ–
[5b] main_dep.py (é“¾å¼è®­ç»ƒ)
    â†“
è¾“å‡ºï¼šoutput/binary_ind1/ æˆ– output/binary_dep/
```

---

## äº”ã€å…³é”®è®¾è®¡äº®ç‚¹

### 1. **è¢«è¯•ç‹¬ç«‹æ€§ä¿è¯** (`main_loso.py`)
- æµ‹è¯•é›†=å®Œæ•´çš„1ä¸ªè¢«è¯•ï¼Œé¿å…æ•°æ®æ³„éœ²
- éªŒè¯é›†æ¥è‡ªå…¶ä»–è¢«è¯•ï¼Œç¡®ä¿æ³›åŒ–æ€§

### 2. **è·¨è¢«è¯•æ ‡å‡†åŒ–** (`make_pkl_ind.py`)
- Facialç‰¹å¾ä½¿ç”¨è®­ç»ƒé›†ç»Ÿè®¡é‡æ ‡å‡†åŒ–
- é¿å…æµ‹è¯•é›†ä¿¡æ¯æ³„éœ²

### 3. **æ¦‚ç‡æ ¡å‡†** (`evaluate.py`)
- ä¸‰ç§æ ¡å‡†æ–¹æ³•è‡ªåŠ¨é€‰æ‹©
- é’ˆå¯¹ç±»åˆ«ä¸å¹³è¡¡çš„åå¤„ç†ä¼˜åŒ–

### 4. **é˜ˆå€¼ä¼˜åŒ–**
- Ï„*: åœ¨Valä¸ŠæŒ‰BA/ACCé€‰å‡º
- Ï„_Ï€: æŒ‰å…ˆéªŒåˆ†å¸ƒåŒ¹é…
- EMæ ¡æ­£: å¤„ç†è®­ç»ƒ-æµ‹è¯•åˆ†å¸ƒåç§»

### 5. **å°æ‰¹é‡é€‚é…** (`main_loso.py`)
- GroupNormæ›¿ä»£BatchNormï¼ˆLOSOæ—¶éªŒè¯é›†å¯èƒ½å¾ˆå°ï¼‰
- Warmupå­¦ä¹ ç‡ï¼ˆç¨³å®šè®­ç»ƒåˆæœŸï¼‰

---

## å…­ã€æ–‡ä»¶åˆ†ç±»æ€»ç»“

| ç±»åˆ« | æ–‡ä»¶ |
|------|------|
| **æ•°æ®é¢„å¤„ç†** | `extract_video_frames_all.py`, `resnet_png_to_npy.py`, `repair_missing.py`, `make_pkl.py`, `make_pkl_ind.py` |
| **æ¨¡å‹æ¶æ„** | `encoder.py`, `fusion.py`, `attention.py`, `loss.py` |
| **æ•°æ®åŠ è½½** | `Multimodal_dataset.py` |
| **è®­ç»ƒè„šæœ¬** | `main.py`, `main_loso.py`, `main_dep.py` |
| **è¯„ä¼°å·¥å…·** | `evaluate.py`, `evaluate_new.py` |
| **è¾…åŠ©å·¥å…·** | `trail.py` |
| **åºŸå¼ƒ/æœªç”¨** | `openface_preprocess.py`, `fusion_modules.py` |

---
